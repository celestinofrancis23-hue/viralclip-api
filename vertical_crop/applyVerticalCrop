const fs = require('fs');
const path = require('path');
const { exec } = require('child_process');

/**
 * Apply Vertical Crop (9:16)
 * Responsabilidade √∫nica:
 * - Receber a decis√£o da MarvelVerticalCrop
 * - Aplicar o crop exatamente como decidido
 * - Gerar o v√≠deo final
 *
 * N√ÉO cont√©m l√≥gica de decis√£o.
 * N√ÉO altera estrat√©gia.
 * N√ÉO recalcula nada.
 */

async function applyVerticalCrop({
  jobId,
  clipId,
  inputVideoPath,
  outputVideoPath,
  cropDecision,
}) {
  // ============================
  // VALIDACOES
  // ============================
  if (!jobId) throw new Error('[applyVerticalCrop] jobId ausente');
  if (!clipId) throw new Error('[applyVerticalCrop] clipId ausente');

  if (!inputVideoPath || !fs.existsSync(inputVideoPath)) {
    throw new Error('[applyVerticalCrop] inputVideoPath inv√°lido ou inexistente');
  }

  if (!outputVideoPath) {
    throw new Error('[applyVerticalCrop] outputVideoPath ausente');
  }

  if (!cropDecision) {
    throw new Error('[applyVerticalCrop] cropDecision ausente');
  }

  const { cropX, cropY, cropWidth, cropHeight, strategy } = cropDecision;

  if (
    [cropX, cropY, cropWidth, cropHeight].some(
      (v) => typeof v !== 'number' || isNaN(v)
    )
  ) {
    throw new Error('[applyVerticalCrop] cropDecision inv√°lido');
  }

  // ============================
  // GARANTIR DIRETORIO DE OUTPUT
  // ============================
  fs.mkdirSync(path.dirname(outputVideoPath), { recursive: true });

  // ============================
  // LOG DE DEBUG PROFISSIONAL
  // ============================
  console.log('üé¨ ApplyVerticalCrop', {
    jobId,
    clipId,
    strategy,
    crop: {
      x: cropX,
      y: cropY,
      width: cropWidth,
      height: cropHeight,
    },
  });

  // ============================
  // COMANDO FFMPEG
  // ============================
  /**
   * Importante:
   * - crop vem ANTES do scale
   * - garante que n√£o h√° distor√ß√£o
   * - sa√≠da padronizada 9:16 (720x1280)
   */
  const ffmpegCmd = `
    ffmpeg -y -i "${inputVideoPath}" \
    -vf "crop=${cropWidth}:${cropHeight}:${cropX}:${cropY},scale=720:1280" \
    -c:v libx264 -preset fast -crf 18 \
    -pix_fmt yuv420p \
    -movflags +faststart \
    -c:a copy \
    "${outputVideoPath}"
  `;

  await execPromise(ffmpegCmd);

  // ============================
  // VALIDACAO FINAL
  // ============================
  if (!fs.existsSync(outputVideoPath)) {
    throw new Error('[applyVerticalCrop] v√≠deo final n√£o foi gerado');
  }

  console.log('‚úÖ Vertical crop aplicado com sucesso:', outputVideoPath);

  // ============================
  // OUTPUT LIMPO
  // ============================
  return {
    jobId,
    clipId,
    outputVideoPath,
    appliedCrop: {
      x: cropX,
      y: cropY,
      width: cropWidth,
      height: cropHeight,
      strategy,
    },
  };
}

// ============================
// HELPER
// ============================

function execPromise(command) {
  return new Promise((resolve, reject) => {
    exec(command, (error, stdout, stderr) => {
      if (error) {
        console.error('‚ùå FFmpeg stderr:', stderr);
        return reject(error);
      }
      resolve();
    });
  });
}

module.exports = applyVerticalCrop;
